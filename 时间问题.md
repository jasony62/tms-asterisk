> Asterisk 现有版本不支持播放视频文件（支持视频通话），无法满足发送视频通知、视频 IVR 等场景。本系列文章，通过学习音视频的相关知识和工具，尝试实现一个通过 Asterisk 播放 mp4 视频文件的应用。

# h264 帧顺序

编码顺序和显示顺序。

POC picture order count 顺序计数器，代表现实顺序。

frame_num 是一个顺序计数器，代表帧的编码顺序。

# rtp 帧顺序

时间戳是传送包的第一个字节的采样时间。

时间戳的单位由媒体流的时间基决定，例如：h264 的 90000，pcma 的 8000 等。

时间戳的初始值是个随机数。

几个包的时间戳可以相同，如果它们中的数据是在同一时间开始的，例如：一个视频帧分成几个包穿。

不通媒体流之间的时间戳是独立的。

通过 rtcp 解决同步问题

NTP timestamp: 64 bits

RTP timestamp: 32 bits

![RTCP包结构](https://upload-images.jianshu.io/upload_images/258497-4b9db8cad811e054.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

rtcp 的发送机制是什么？

asterisk 中如何发送 rtcp 包？

# sip 终端（linphone）处理机制

播放一个 10s 的视频，快速发送，在 rtp 帧间不添加间隔，时间戳正常。红色 5 秒，绿色 5 秒，只能看到红色。红色 2 秒，绿色 8 秒，可以看到红色和绿色，但是红色播放不足两秒。说明 linphone 不是完全按照 h264 的 dts 和 pts 时间，也不是完全按照 rtp 的时间戳时间，进行解码和播放。

![快发红2秒绿4秒抓包](https://upload-images.jianshu.io/upload_images/258497-b9a60d3f98381887.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# 音视频不同步

比较 mp4 文件中 9 秒音频和 8 秒音频的 chunk 起始位置。

![延迟1秒开始音频](https://upload-images.jianshu.io/upload_images/258497-e6a97c189bdc3300.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![延迟2秒开始音频](https://upload-images.jianshu.io/upload_images/258497-7ab29a33c5523506.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

读取 mp4 文件可以自然解决音视频同步问题？

# 其它

手机端 linphone 的奇怪现象

解决的办法

多个文件的播放，解决交互视频的一种方式？

mp4 文件的音频采样率

产生静音视频的另一种方法

> ffmpeg -t 1 -lavfi anullsrc=r=8000:cl=mono -lavfi color=blue -c:v libx264 -profile:v baseline -level 3.1 anullsrc-blue-1s.mp4

# ffprobe 命令

查看媒体文件基本信息

> ffprobe sine-red-10s.mp4

查看媒体文件的 packet 并输出到文件

> ffprobe -show_packets color-red-10s.h264 > packets.txt

查看媒体文件的 frame 并输出到文件

> ffprobe -show_frames color-red-10s.h264 > frames.txt
